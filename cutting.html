<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªëi ∆Øu C·∫Øt V·∫≠t Li·ªáu ƒêa NƒÉng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 0 auto; background: #252526; padding: 30px; border-radius: 10px; border: 1px solid #3e3e42; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #4ec9b0; margin-top: 0; }
        
        .control-group { margin-bottom: 20px; text-align: left; background: #333; padding: 15px; border-radius: 8px;}
        label { display: block; margin-bottom: 5px; color: #ce9178; font-weight: bold; }
        
        /* Input & Select Style */
        select, input { padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; font-size: 14px; font-weight: bold; outline: none;}
        input { text-align: center; }
        select { width: 100%; cursor: pointer; }
        select:focus, input:focus { border-color: #4ec9b0; background: #2a2a2a; }

        /* B·∫£ng nh·∫≠p li·ªáu */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #aaa; padding: 5px; border-bottom: 1px solid #555; }
        td { padding: 5px; }
        .input-len { width: 100%; box-sizing: border-box; }
        .input-qty { width: 100%; box-sizing: border-box; }
        
        /* Buttons */
        .btn { border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; transition: 0.3s;}
        .btn-add { background: #569cd6; font-size: 14px;}
        .btn-del { background: #ff5555; padding: 5px 10px; }
        .btn-back { background-color: #444; margin-bottom: 20px; padding: 8px 15px; text-decoration: none; display: inline-block; color: white; border-radius: 4px;}
        
        .btn-calc { background: #d16d00; width: 100%; font-size: 18px; margin-top: 20px; text-transform: uppercase;}
        .btn-calc:hover { background: #e67e00; }

        .btn-excel { background: #217346; width: 100%; font-size: 18px; margin-top: 10px; display: none; }
        .btn-excel:hover { background: #1e6b41; }

        /* K·∫øt qu·∫£ */
        #result-area { margin-top: 30px; text-align: left; display: none; }
        .bar-container { margin-bottom: 20px; background: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 5px; }
        .bar-title { font-weight: bold; color: #4ec9b0; margin-bottom: 5px; display: flex; justify-content: space-between; }
        
        .visual-bar { height: 35px; background: #333; display: flex; border-radius: 4px; overflow: hidden; margin-top: 5px; position: relative;}
        .segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #000; font-weight: bold; border-right: 1px solid rgba(0,0,0,0.2); white-space: nowrap; overflow: hidden;}
        .seg-part { background: #4caf50; color: white; }
        .seg-waste { background: #ff5555; color: white; }
        .seg-blade { background: #000; width: 2px; } /* M·∫°ch c·∫Øt hi·ªÉn th·ªã d·∫°ng v·∫°ch ƒëen */

        .summary-box { background: #0e639c; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white; }
        
        /* Grid cho ph·∫ßn c·∫•u h√¨nh */
        .config-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: end; }
        @media (max-width: 600px) { .config-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <a href="index.html" class="btn-back">‚¨Ö Quay l·∫°i Trang ch·ªß</a>

    <div class="container">
        <h1>‚úÇÔ∏è T·ªêI ∆ØU C·∫ÆT ƒêA NƒÇNG</h1>
        
        <div class="control-group">
            <label>1. Ch·ªçn lo·∫°i V·∫≠t Li·ªáu & K√≠ch th∆∞·ªõc ph√¥i:</label>
            <div class="config-grid">
                <div>
                    <label style="font-size: 0.8em; color: #aaa;">Lo·∫°i v·∫≠t li·ªáu:</label>
                    <select id="materialType" onchange="updatePreset()">
                        <option value="custom">-- T√πy ch·ªânh (Nh·∫≠p tay) --</option>
                        <option value="steel6" selected>S·∫Øt h·ªôp / Th√©p V (6m)</option>
                        <option value="steel11">Th√©p x√¢y d·ª±ng (11.7m)</option>
                        <option value="alu58">Nh√¥m Xingfa/K√≠nh (5.8m)</option>
                        <option value="alu6">Nh√¥m Thanh (6m)</option>
                        <option value="inox6">Inox / Th√©p kh√¥ng g·ªâ (6m)</option>
                        <option value="pvc4">·ªêng n∆∞·ªõc PVC (4m)</option>
                        <option value="wood24">V√°n g·ªó / G·ªó thanh (2.44m)</option>
                        <option value="wood3">G·ªó t·ª± nhi√™n (3m)</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.8em; color: #aaa;">D√†i c√¢y (mm):</label>
                    <input type="number" id="stockLength" value="6000">
                </div>
                <div>
                    <label style="font-size: 0.8em; color: #aaa;">L∆∞·ª°i c·∫Øt (mm):</label>
                    <input type="number" id="bladeWidth" value="4">
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>2. Nh·∫≠p danh s√°ch c·∫ßn c·∫Øt:</label>
            <table id="inputTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">STT</th>
                        <th>Chi·ªÅu d√†i (mm)</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th style="width: 50px;">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td>1</td>
                        <td><input type="number" class="input-len" value="1200"></td>
                        <td><input type="number" class="input-qty" value="4"></td>
                        <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><input type="number" class="input-len" value="2500"></td>
                        <td><input type="number" class="input-qty" value="2"></td>
                        <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-add" onclick="addRow()">+ Th√™m d√≤ng m·ªõi</button>
        </div>

        <button class="btn btn-calc" onclick="calculateCut()">üöÄ T√çNH TO√ÅN NGAY</button>
        <button class="btn btn-excel" id="btnExport" onclick="exportExcel()">üì• XU·∫§T EXCEL (.XLSX)</button>

        <div id="result-area">
            <div class="summary-box" id="summary"></div>
            <div id="bars-list"></div>
        </div>
    </div>

    <script>
        // D·ªÆ LI·ªÜU C·∫§U H√åNH M·∫∂C ƒê·ªäNH
        const presets = {
            'custom': { len: 0, blade: 0 }, // Kh√¥ng ƒë·ªïi
            'steel6': { len: 6000, blade: 4 }, // ƒê√° c·∫Øt s·∫Øt th∆∞·ªùng d√†y 3-4mm
            'steel11': { len: 11700, blade: 5 }, // C·∫Øt th√©p c√¢y l·ªõn
            'alu58': { len: 5800, blade: 3 }, // L∆∞·ª°i c·∫Øt nh√¥m m·ªèng h∆°n
            'alu6': { len: 6000, blade: 3 },
            'inox6': { len: 6000, blade: 2 }, // ƒêƒ©a c·∫Øt inox m·ªèng
            'pvc4': { len: 4000, blade: 2 }, // C∆∞a tay ho·∫∑c m√°y c·∫Øt nh·ªè
            'wood24': { len: 2440, blade: 3 }, // L∆∞·ª°i c∆∞a g·ªó
            'wood3': { len: 3000, blade: 3 }
        };

        let globalResult = null;

        // H√†m c·∫≠p nh·∫≠t khi ch·ªçn v·∫≠t li·ªáu
        function updatePreset() {
            const type = document.getElementById('materialType').value;
            const data = presets[type];
            
            if (type !== 'custom') {
                document.getElementById('stockLength').value = data.len;
                document.getElementById('bladeWidth').value = data.blade;
            }
        }

        function addRow() {
            const tbody = document.getElementById('tableBody');
            const rowCount = tbody.rows.length + 1;
            const row = `
                <tr>
                    <td>${rowCount}</td>
                    <td><input type="number" class="input-len" placeholder="D√†i..."></td>
                    <td><input type="number" class="input-qty" value="1"></td>
                    <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
            updateIndex();
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            updateIndex();
        }

        function updateIndex() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].innerText = index + 1;
            });
        }

        function calculateCut() {
            const stockLen = parseInt(document.getElementById('stockLength').value);
            const blade = parseInt(document.getElementById('bladeWidth').value);
            const matName = document.getElementById('materialType').options[document.getElementById('materialType').selectedIndex].text;
            
            // 1. L·∫•y d·ªØ li·ªáu input
            let parts = [];
            let isValid = true;

            document.querySelectorAll('#tableBody tr').forEach(row => {
                const len = parseInt(row.querySelector('.input-len').value);
                const qty = parseInt(row.querySelector('.input-qty').value);
                
                if (len && qty && len > 0 && qty > 0) {
                    if (len > stockLen) {
                        alert(`L·ªói: C√≥ ƒëo·∫°n d√†i ${len}mm > C√¢y nguy√™n li·ªáu (${stockLen}mm)!`);
                        isValid = false;
                        return;
                    }
                    for(let i=0; i<qty; i++) parts.push(len);
                }
            });

            if(!isValid) return;
            if(parts.length === 0) { alert("Vui l√≤ng nh·∫≠p k√≠ch th∆∞·ªõc c·∫ßn c·∫Øt!"); return; }

            // 2. Thu·∫≠t to√°n Greedy (First Fit Decreasing)
            parts.sort((a, b) => b - a); // S·∫Øp x·∫øp gi·∫£m d·∫ßn

            let bars = [];
            parts.forEach(part => {
                let placed = false;
                for (let bar of bars) {
                    // Ki·ªÉm tra xem c√¢y n√†y c√≤n ƒë·ªß ch·ªó kh√¥ng
                    if (bar.remaining >= part) {
                        bar.cuts.push(part);
                        // Tr·ª´ ƒëi ƒëo·∫°n c·∫Øt V√Ä m·∫°ch c·∫Øt
                        bar.remaining -= (part + blade);
                        placed = true;
                        break;
                    }
                }
                
                // N·∫øu kh√¥ng nh√©t v·ª´a c√¢y n√†o, l·∫•y c√¢y m·ªõi
                if (!placed) {
                    let newBar = {
                        id: bars.length + 1,
                        cuts: [part],
                        // C√¢y m·ªõi tr·ª´ ƒëi ƒëo·∫°n ƒë·∫ßu ti√™n v√† m·∫°ch c·∫Øt c·ªßa n√≥
                        remaining: stockLen - part - blade 
                    };
                    bars.push(newBar);
                }
            });

            // 3. Render k·∫øt qu·∫£
            renderResult(bars, stockLen, blade, matName);
        }

        function renderResult(bars, stockLen, blade, matName) {
            const resArea = document.getElementById('result-area');
            const summary = document.getElementById('summary');
            const list = document.getElementById('bars-list');
            const btnExport = document.getElementById('btnExport');
            
            let totalWasteLen = 0;
            
            // T√≠nh to√°n l·∫°i ph·∫ßn d∆∞ th·ª±c t·∫ø (C·ªông l·∫°i m·∫°ch c·∫Øt cu·ªëi c√πng v√¨ nh√°t c·∫Øt cu·ªëi kh√¥ng t·ªën ph√¥i ph√≠a sau)
            // Tuy nhi√™n ƒë·ªÉ an to√†n cho th·ª£, ta c·ª© gi·ªØ nguy√™n logic l√† m·ªói nh√°t c·∫Øt ƒë·ªÅu t·ªën.
            bars.forEach(b => {
                if(b.remaining < 0) b.remaining = 0;
                totalWasteLen += b.remaining;
            });
            
            let totalUsed = bars.length * stockLen;
            let wastePercent = (totalWasteLen / totalUsed * 100).toFixed(2);

            // L∆∞u d·ªØ li·ªáu to√†n c·ª•c ƒë·ªÉ xu·∫•t Excel
            globalResult = { bars, stockLen, blade, totalWaste: totalWasteLen, wastePercent, matName };

            summary.innerHTML = `
                <h3>K·∫æT QU·∫¢: ${matName}</h3>
                <div>Chi·ªÅu d√†i c√¢y: <b>${stockLen} mm</b> | L∆∞·ª°i c·∫Øt: <b>${blade} mm</b></div>
                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2); margin: 10px 0;">
                <div style="font-size: 1.2em;">T·ªïng s·ªë c√¢y c·∫ßn d√πng: <b style="color: #ffeb3b">${bars.length} c√¢y</b></div>
                <div>T·ªïng ƒëo·∫°n th·ª´a (Decal): <b>${totalWasteLen} mm</b> (${wastePercent}%)</div>
            `;

            list.innerHTML = "";

            bars.forEach(bar => {
                let cutsHtml = "";
                
                bar.cuts.forEach(c => {
                    let widthPercent = (c / stockLen) * 100;
                    cutsHtml += `<div class="segment seg-part" style="width: ${widthPercent}%" title="C·∫Øt: ${c}mm">${c}</div>`;
                    
                    // V·∫Ω m·∫°ch c·∫Øt
                    if(blade > 0) {
                        let bladePercent = (blade / stockLen) * 100;
                        cutsHtml += `<div class="segment seg-blade" style="width: ${bladePercent}%"></div>`;
                    }
                });

                let wasteLen = bar.remaining;
                if (wasteLen > 0) {
                     let wastePercent = (wasteLen / stockLen) * 100;
                     cutsHtml += `<div class="segment seg-waste" style="width: ${wastePercent}%" title="Th·ª´a: ${wasteLen}mm">${wasteLen}</div>`;
                }

                let textDetail = bar.cuts.join(" + ");

                list.innerHTML += `
                    <div class="bar-container">
                        <div class="bar-title">
                            <span>C√¢y s·ªë ${bar.id}</span>
                            <span style="color: #ff5555">D∆∞: ${wasteLen}mm</span>
                        </div>
                        <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">C·∫Øt: ${textDetail}</div>
                        <div class="visual-bar">${cutsHtml}</div>
                    </div>
                `;
            });

            resArea.style.display = "block";
            btnExport.style.display = "inline-block";
        }

        function exportExcel() {
            if (!globalResult) return;

            const ws_data = [
                ["B·∫¢NG T√çNH C·∫ÆT V·∫¨T LI·ªÜU"],
                ["Ng√†y xu·∫•t:", new Date().toLocaleString()],
                [],
                ["TH√îNG TIN V·∫¨T LI·ªÜU"],
                ["Lo·∫°i v·∫≠t li·ªáu:", globalResult.matName],
                ["Chi·ªÅu d√†i c√¢y (mm):", globalResult.stockLen],
                ["ƒê·ªô d√†y l∆∞·ª°i c·∫Øt (mm):", globalResult.blade],
                [],
                ["K·∫æT QU·∫¢ T·ªîNG H·ª¢P"],
                ["T·ªïng s·ªë c√¢y c·∫ßn d√πng:", globalResult.bars.length + " c√¢y"],
                ["T·ªïng ph·∫ßn th·ª´a:", globalResult.totalWaste + " mm"],
                ["Hao h·ª•t:", globalResult.wastePercent + " %"],
                [],
                ["CHI TI·∫æT C·∫ÆT T·ª™NG C√ÇY"],
                ["STT C√¢y", "C√°c ƒëo·∫°n c·∫Øt (mm)", "Ph·∫ßn th·ª´a (mm)"]
            ];

            globalResult.bars.forEach(bar => {
                ws_data.push([
                    bar.id,
                    bar.cuts.join(" + "),
                    bar.remaining
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // ƒê·ªãnh d·∫°ng c·ªôt r·ªông ra cho d·ªÖ ƒë·ªçc
            ws['!cols'] = [{wch: 15}, {wch: 50}, {wch: 15}];

            XLSX.utils.book_append_sheet(wb, ws, "Cat_Vat_Lieu");
            XLSX.writeFile(wb, "Cutting_List_Pro.xlsx");
        }
    </script>
</body>
</html>
