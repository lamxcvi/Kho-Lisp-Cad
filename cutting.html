<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªëi ∆Øu C·∫Øt V·∫≠t Li·ªáu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 0 auto; background: #252526; padding: 30px; border-radius: 10px; border: 1px solid #3e3e42; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #4ec9b0; margin-top: 0; }
        
        .control-group { margin-bottom: 20px; text-align: left; background: #333; padding: 15px; border-radius: 8px;}
        label { display: block; margin-bottom: 5px; color: #ce9178; font-weight: bold; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; width: 100px; text-align: center; font-weight: bold;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #aaa; padding: 5px; border-bottom: 1px solid #555; }
        td { padding: 5px; }
        .input-len { width: 100%; box-sizing: border-box; }
        .input-qty { width: 100%; box-sizing: border-box; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; transition: 0.3s;}
        .btn-add { background: #569cd6; font-size: 14px;}
        .btn-del { background: #ff5555; padding: 5px 10px; }
        .btn-back { background-color: #444; margin-bottom: 20px; padding: 8px 15px; text-decoration: none; display: inline-block; color: white; border-radius: 4px;}
        
        /* N√∫t t√≠nh to√°n */
        .btn-calc { background: #d16d00; width: 100%; font-size: 18px; margin-top: 20px;}
        .btn-calc:hover { background: #e67e00; }

        /* N√∫t xu·∫•t Excel (M·∫∑c ƒë·ªãnh ·∫©n) */
        .btn-excel { background: #217346; width: 100%; font-size: 18px; margin-top: 10px; display: none; }
        .btn-excel:hover { background: #1e6b41; }

        /* K·∫øt qu·∫£ */
        #result-area { margin-top: 30px; text-align: left; display: none; }
        .bar-container { margin-bottom: 20px; background: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 5px; }
        .bar-title { font-weight: bold; color: #4ec9b0; margin-bottom: 5px; display: flex; justify-content: space-between; }
        
        .visual-bar { height: 30px; background: #333; display: flex; border-radius: 4px; overflow: hidden; margin-top: 5px;}
        .segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #000; font-weight: bold; border-right: 1px solid rgba(0,0,0,0.2); transition: width 0.5s;}
        .seg-part { background: #4caf50; color: white;}
        .seg-waste { background: #ff5555; color: white;}

        .summary-box { background: #0e639c; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-back">‚¨Ö Quay l·∫°i Trang ch·ªß</a>

    <div class="container">
        <h1>‚úÇÔ∏è T·ªêI ∆ØU C·∫ÆT V·∫¨T LI·ªÜU</h1>
        
        <div class="control-group">
            <div style="display: flex; gap: 20px; align-items: flex-end;">
                <div>
                    <label>Chi·ªÅu d√†i c√¢y nguy√™n (mm):</label>
                    <input type="number" id="stockLength" value="6000">
                </div>
                <div>
                    <label>ƒê·ªô d√†y l∆∞·ª°i c·∫Øt (mm):</label>
                    <input type="number" id="bladeWidth" value="5">
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>Danh s√°ch c·∫ßn c·∫Øt:</label>
            <table id="inputTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Chi·ªÅu d√†i (mm)</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>X√≥a</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td>1</td>
                        <td><input type="number" class="input-len" value="1500"></td>
                        <td><input type="number" class="input-qty" value="2"></td>
                        <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><input type="number" class="input-len" value="2000"></td>
                        <td><input type="number" class="input-qty" value="3"></td>
                        <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-add" onclick="addRow()">+ Th√™m d√≤ng</button>
        </div>

        <button class="btn btn-calc" onclick="calculateCut()">üöÄ T√çNH TO√ÅN PH∆Ø∆†NG √ÅN C·∫ÆT</button>
        <button class="btn btn btn-excel" id="btnExport" onclick="exportExcel()">üì• XU·∫§T FILE EXCEL (.XLSX)</button>

        <div id="result-area">
            <div class="summary-box" id="summary"></div>
            <div id="bars-list"></div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u k·∫øt qu·∫£ cho vi·ªác xu·∫•t Excel
        let globalResult = {
            bars: [],
            stockLen: 0,
            blade: 0,
            totalWaste: 0,
            wastePercent: 0
        };

        function addRow() {
            const tbody = document.getElementById('tableBody');
            const rowCount = tbody.rows.length + 1;
            const row = `
                <tr>
                    <td>${rowCount}</td>
                    <td><input type="number" class="input-len" placeholder="Nh·∫≠p d√†i"></td>
                    <td><input type="number" class="input-qty" value="1"></td>
                    <td><button class="btn btn-del" onclick="deleteRow(this)">X</button></td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
            updateIndex();
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            updateIndex();
        }

        function updateIndex() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].innerText = index + 1;
            });
        }

        function calculateCut() {
            const stockLen = parseInt(document.getElementById('stockLength').value);
            const blade = parseInt(document.getElementById('bladeWidth').value);
            
            // 1. L·∫•y d·ªØ li·ªáu input
            let parts = [];
            document.querySelectorAll('#tableBody tr').forEach(row => {
                const len = parseInt(row.querySelector('.input-len').value);
                const qty = parseInt(row.querySelector('.input-qty').value);
                if (len && qty && len > 0 && qty > 0) {
                    if (len > stockLen) {
                        alert(`L·ªói: ƒêo·∫°n ${len}mm d√†i h∆°n c√¢y nguy√™n (${stockLen}mm)!`);
                        return;
                    }
                    for(let i=0; i<qty; i++) parts.push(len);
                }
            });

            if(parts.length === 0) { alert("Vui l√≤ng nh·∫≠p k√≠ch th∆∞·ªõc c·∫ßn c·∫Øt!"); return; }

            // 2. Thu·∫≠t to√°n Greedy
            parts.sort((a, b) => b - a);

            let bars = [];
            parts.forEach(part => {
                let placed = false;
                for (let bar of bars) {
                    if (bar.remaining >= part) {
                        bar.cuts.push(part);
                        bar.remaining -= (part + blade);
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    let newBar = {
                        id: bars.length + 1,
                        cuts: [part],
                        remaining: stockLen - part - blade
                    };
                    bars.push(newBar);
                }
            });

            // 3. Hi·ªÉn th·ªã k·∫øt qu·∫£ & L∆∞u bi·∫øn to√†n c·ª•c
            renderResult(bars, stockLen, blade);
        }

        function renderResult(bars, stockLen, blade) {
            const resArea = document.getElementById('result-area');
            const summary = document.getElementById('summary');
            const list = document.getElementById('bars-list');
            const btnExport = document.getElementById('btnExport');
            
            let totalWasteLen = 0;
            bars.forEach(b => {
                if(b.remaining < 0) b.remaining = 0;
                totalWasteLen += b.remaining;
            });
            
            let totalUsed = bars.length * stockLen;
            let wastePercent = (totalWasteLen / totalUsed * 100).toFixed(2);

            // L∆∞u d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel
            globalResult = { bars, stockLen, blade, totalWaste: totalWasteLen, wastePercent };

            summary.innerHTML = `
                <h3>K·∫æT QU·∫¢ T√çNH TO√ÅN</h3>
                <div>T·ªïng s·ªë c√¢y c·∫ßn d√πng: <b>${bars.length} c√¢y</b> (L= ${stockLen}mm)</div>
                <div>T·ªïng ƒëo·∫°n th·ª´a (Decal): <b>${totalWasteLen} mm</b> (${wastePercent}%)</div>
            `;

            list.innerHTML = "";

            bars.forEach(bar => {
                let cutsHtml = "";
                bar.cuts.forEach(c => {
                    let widthPercent = (c / stockLen) * 100;
                    cutsHtml += `<div class="segment seg-part" style="width: ${widthPercent}%" title="C·∫Øt: ${c}mm">${c}</div>`;
                    let bladePercent = (blade / stockLen) * 100;
                    if(blade > 0) cutsHtml += `<div class="segment" style="width: ${bladePercent}%; background: #000;"></div>`;
                });

                let wasteLen = bar.remaining;
                if (wasteLen > 0) {
                     let wastePercent = (wasteLen / stockLen) * 100;
                     cutsHtml += `<div class="segment seg-waste" style="width: ${wastePercent}%" title="Th·ª´a: ${wasteLen}mm">${wasteLen}</div>`;
                }

                let textDetail = bar.cuts.join(" + ");

                list.innerHTML += `
                    <div class="bar-container">
                        <div class="bar-title">
                            <span>C√¢y s·ªë ${bar.id}</span>
                            <span style="color: #ff5555">D∆∞: ${wasteLen}mm</span>
                        </div>
                        <div style="font-size: 0.9em; color: #888;">C·∫Øt: ${textDetail}</div>
                        <div class="visual-bar">${cutsHtml}</div>
                    </div>
                `;
            });

            resArea.style.display = "block";
            btnExport.style.display = "inline-block"; // Hi·ªán n√∫t Excel
        }

        function exportExcel() {
            if (globalResult.bars.length === 0) return;

            // 1. T·∫°o d·ªØ li·ªáu Excel
            // D√≤ng ti√™u ƒë·ªÅ t·ªïng h·ª£p
            const ws_data = [
                ["B·∫¢NG T√çNH C·∫ÆT V·∫¨T LI·ªÜU (CUTTING LIST)"],
                ["Ng√†y xu·∫•t:", new Date().toLocaleString()],
                [],
                ["TH√îNG S·ªê ƒê·∫¶U V√ÄO"],
                ["Chi·ªÅu d√†i c√¢y:", globalResult.stockLen + " mm"],
                ["M·∫°ch c·∫Øt (l∆∞·ª°i c∆∞a):", globalResult.blade + " mm"],
                [],
                ["T·ªîNG H·ª¢P K·∫æT QU·∫¢"],
                ["T·ªïng s·ªë c√¢y:", globalResult.bars.length + " c√¢y"],
                ["T·ªïng ph·∫ßn th·ª´a:", globalResult.totalWaste + " mm"],
                ["Hao h·ª•t:", globalResult.wastePercent + " %"],
                [],
                ["CHI TI·∫æT C·∫ÆT"],
                ["STT C√¢y", "C√°c ƒëo·∫°n c·∫Øt (mm)", "Ph·∫ßn th·ª´a (mm)"] // Header b·∫£ng
            ];

            // D√≤ng d·ªØ li·ªáu chi ti·∫øt
            globalResult.bars.forEach(bar => {
                ws_data.push([
                    bar.id,
                    bar.cuts.join(" + "),
                    bar.remaining
                ]);
            });

            // 2. T·∫°o Workbook v√† Worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Ch·ªânh ƒë·ªô r·ªông c·ªôt cho ƒë·∫πp
            ws['!cols'] = [{wch: 10}, {wch: 40}, {wch: 15}];

            // Th√™m Sheet v√†o Workbook
            XLSX.utils.book_append_sheet(wb, ws, "DanhSachCat");

            // 3. Xu·∫•t file
            XLSX.writeFile(wb, "Cutting_List.xlsx");
        }
    </script>
</body>
</html>
